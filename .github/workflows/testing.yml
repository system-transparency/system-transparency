---

name: Testing

on:
  - push

jobs:
  ubuntu20_network:
    runs-on: ubuntu-20.04
    steps:
      - name: Install Go
        run: |
          DEBIAN_FRONTEND=noninteractive sudo apt-get -qq update
          DEBIAN_FRONTEND=noninteractive sudo apt-get -qqy install golang

      - name: Checkout
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          source env.sh
          task deps:install

      - name: Build default config
        run: |
          source env.sh
          task config

      - name: Set boot mode to network
        run: sed -i 's/ST_BOOT_MODE=local/ST_BOOT_MODE=network/' .config

      - name: Generate example sign keys
        run: |
          source env.sh
          task keygen:sign

      - name: Build MBR bootloader installation
        run: |
          source env.sh
          task image-mbr

      - name: Build EFI application installation
        run: |
          source env.sh
          task image-efi

  ubuntu18_network:
    runs-on: ubuntu-18.04
    steps:
      - name: Install Go
        run: |
          go_tmp_dir=`mktemp -d`
          wget -qP $go_tmp_dir https://dl.google.com/go/go1.17.linux-amd64.tar.gz
          export GOROOT=/usr/local/go-1.17
          sudo mkdir -p $GOROOT
          sudo tar xf $go_tmp_dir/go1.17.linux-amd64.tar.gz -C $GOROOT --strip 1
          echo "export PATH=$GOROOT/bin:$PATH" >> ~/.profile
          rm -r $go_tmp_dir

      - name: Checkout
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          source env.sh
          task deps:install

      - name: Build default config
        run: |
          source env.sh
          task config

      - name: Set boot mode to network
        run: sed -i 's/ST_BOOT_MODE=local/ST_BOOT_MODE=network/' .config

      - name: Generate example sign keys
        run: |
          source env.sh
          go env
          task keygen:sign

      - name: Build MBR bootloader installation
        run: |
          source env.sh
          task image-mbr

      - name: Build EFI application installation
        run: |
          source env.sh
          task image-efi
