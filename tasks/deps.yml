version: '3'

vars:
  DPKGS: >-
    curl xz-utils git gcc make bc dosfstools udev swtpm
    flex bison pkg-config libelf-dev gpg jq e2tools mtools
    parted xorriso python3 supervisor

tasks:

  install:
    desc: Install Debian/Ubuntu dependencies
    cmds:
      - cmd: "{{.SUDO}} apt-get update -y"
        silent: false
      - cmd: "{{.SUDO}} apt-get install -y {{.DPKGS}}"
        silent: false
    preconditions:
      - sh: '[[ -f /etc/os-release ]] && sed -n "s/^ID.*=\(.*\)$/\1/p" /etc/os-release|grep -q debian'
        msg: "OS is not debian based"
    vars:
      SUDO:
        sh: '[ "$UID" -eq "0" ] || echo "sudo"'

  check-cmd:
    run: when_changed
    preconditions:
      - sh: '[ -n "{{.CMD}}" ]'
        msg: "task bug: CMD not defined"
      - sh: "command -v {{.CMD}} >/dev/null 2>&1"
        msg: "command not found: \"{{.CMD}}\""
